---
title: "p8105_hw6_jy3186"
author: "Jiayi Yang"
date: "2022-11-26"
output: github_document
---
```{r}
library(tidyverse)
library(dplyr)
library(readr)
library(modelr)
```

# Problem 2
Import and tidy the dataset
```{r, message = FALSE}
homicide_df = 
  read_csv(url("https://github.com/washingtonpost/data-homicides/blob/master/homicide-data.csv?raw=true"))
```
Create a city_state variable (e.g. “Baltimore, MD”), and a binary variable of whether homicide is solved. `solve_status` is 1 when remains unsolved, is 0 when it's solved.
```{r, warning= FALSE}
homicide_new =
homicide_df %>% 
  mutate(city_state = str_c(city, state, sep = ", ")) %>% 
  group_by(city_state)

cleaned_df =
  homicide_new %>% 
   mutate(
    solve_status = ifelse(disposition %in% c("Closed without arrest", "Open/No arrest"),1,0),
    victim_age = as.numeric(victim_age)
  ) %>% 
  drop_na() %>% 
  filter( 
          victim_race %in% c("White", "Black"),
         !city_state %in% c("Dallas, TX", "Phoenix, AZ", "Kansas City, MO", "Tulsa, AL")) 

cleaned_df
```
For the city of Baltimore, MD, use the glm function to fit a logistic regression with resolved vs unresolved as the outcome and victim age, sex and race as predictors.
```{r}
fit_glm = 
  cleaned_df %>% 
  nest(data = -city_state) %>% 
  mutate(
    model = map(data, ~glm(solve_status ~ victim_age + victim_race + victim_sex, data = .x, family = binomial()),
     results = map(model, broom::tidy))
  ) %>%
  select(city_state, results) %>% 
  unnest(results) %>% 
  mutate(OR = exp(estimate),
         CI_lower = exp(estimate -1.96*std.error),
         CI_higher = exp(estimate +1.96*std.error)
         ) %>%
  select(city_state, term, OR, CI_lower, CI_higher) 
fit_glm
```

Now run glm for each of the cities in your dataset, and extract the adjusted odds ratio (and CI) for solving homicides comparing male victims to female victims. 
```{r}

```

## Problem 3
load and tidy data
```{r}
birthweight <- read_csv("birthweight.csv")
birthweight %>% 
  select(bwt, blength, gaweeks, bhead, babysex) %>% 
  drop_na() %>% 
  mutate(
    babysex = case_when(babysex == 1 ~ "Male",
              babysex == 2 ~ "Female") %>% 
      as.factor()
  )
```
regression analysis, made a model
```{r}
model = lm(bwt~gaweeks, data = birthweight)
model
```
show a plot of model residuals against fitted values – use add_predictions and add_residuals in making this plot.
```{r}
resid_plot =
birthweight %>% 
  modelr::add_residuals(model) %>% 
  ggplot(aes(x = gasweeks, y = resid)) + geom_violin()

predict_plot = 
  birthweight %>% 
  modelr::add_predictions(model) %>% 
  ggplot(aes(x = gasweeks, y = resid)) + geom_violin()

```

Compare your model to two others:

One using length at birth and gestational age as predictors (main effects only)
One using head circumference, length, sex, and all interactions (including the three-way interaction) between these

```{r}
model1 = lm(bwt~blength + gaweeks, data = birthweight)
model2 = lm(bwt~bhead*blength*babysex, data = birthweight)
```
Make this comparison in terms of the cross-validated prediction error; use crossv_mc and functions in purrr as appropriate.
```{r}
cv_df = 
  crossv_mc(birthweight, 100) 
```

```{r}
cv_df =
   cv_df %>% 
  mutate(
    train = map(train, as_tibble),
    test = map(test, as_tibble)
  ) %>% 
  mutate(
    mod1 = map(train, ~lm(bwt~gaweeks, data = .x)),
    compare_mod1 = map(train, ~lm(bwt~blength +gaweeks, data = .x)),
    compare_mod2 = map(train, ~lm(bwt~bhead*blength*babysex, data = .x)) 
  ) %>% 
  mutate(
    rmse_mod1 = map2_dbl(mod1, test, ~rmse(model = .x, data = .y)),
    rmse_compare_mod1 = map2_dbl(compare_mod1, test, ~rmse(model = .x, data = .y)),
    rmse_compare_mod2 = map2_dbl(compare_mod2, test, ~rmse(model = .x, data = .y))
  )
```




