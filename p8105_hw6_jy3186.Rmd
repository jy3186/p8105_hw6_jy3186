---
title: "p8105_hw6_jy3186"
author: "Jiayi Yang"
date: "2022-11-26"
output: github_document
---
```{r}
library(tidyverse)
library(dplyr)
library(readr)
```

# Problem 2
Import and tidy the dataset
```{r, message = FALSE}
homicide_df = 
  read_csv(url("https://github.com/washingtonpost/data-homicides/blob/master/homicide-data.csv?raw=true"))
```
Create a city_state variable (e.g. “Baltimore, MD”), and a binary variable of whether homicide is solved. `solve_status` is 1 when remains unsolved, is 0 when it's solved.
```{r, warning= FALSE}
homicide_new =
homicide_df %>% 
  mutate(city_state = str_c(city, state, sep = ", ")) %>% 
  group_by(city_state)

cleaned_df =
  homicide_new %>% 
   mutate(
    solve_status = ifelse(disposition %in% c("Closed without arrest", "Open/No arrest"),1,0),
    victim_age = as.numeric(victim_age)
  ) %>% 
  drop_na() %>% 
  filter( 
          victim_race %in% c("White", "Black"),
         !city_state %in% c("Dallas, TX", "Phoenix, AZ", "Kansas City, MO", "Tulsa, AL")) 

cleaned_df
```
For the city of Baltimore, MD, use the glm function to fit a logistic regression with resolved vs unresolved as the outcome and victim age, sex and race as predictors.
```{r}
Baltimore_df = 
  cleaned_df %>% 
  filter(city == "Baltimore") %>% 
  select(solve_status, victim_age, victim_sex, victim_race)

fit_glm = 
  Baltimore_df %>% 
  glm(solve_status ~ victim_age + victim_race + victim_sex, data = ., family = binomial())

fit_glm
```

Save the output of glm as an R object; apply the broom::tidy to this object; 
odds ratio for solving homicides comparing male victims to female victims keeping all other variables fixed.

```{r}
fit_glm %>% 
  broom::tidy() %>% 
  mutate(
    OR = exp(estimate)
  ) %>% 
  select(term, log_OR = estimate, OR, p.value) %>% 
  knitr::kable(digits = 3)
```
Now run glm for each of the cities in your dataset, and extract the adjusted odds ratio (and CI) for solving homicides comparing male victims to female victims. 
```{r}
glm_map = 
  cleaned_df %>% 
  mutate(
    log = map(.x = data, ~ glm(
      solve_status ~ victim_age + victim_sex + victim_race,
      data = .x,
      family = binomial()
    )
  ), result  = map(log, broom::tidy)) %>%
  select(-data) %>%
  unnest(result) %>%
  mutate(ci = map2(.x = log,
                   .y = term,
                   ~ confint(.x, .y))) %>%
  select(city_state, term, estimate, ci) %>%
  filter(term == "victim_raceWhite")
homicide_df %>%
  head() %>%
  knitr::kable()

```

## Problem 3
load and tidy data
```{r}
birthweight <- read_csv("birthweight.csv")
birthweight %>% 
  select(bwt, blength, gaweeks, bhead, babysex) %>% 
  drop_na() %>% 
  mutate(
    case_when(babysex == 1 ~ "Male",
              babysex == 2 ~ "Female") %>% 
      as.factor()
  )
```



